<!DOCTYPE html>
<html>
  <head>
    <title>New version of HUPLACLIP</title>
    <!-- My scripts -->
    <script src="graphs_generation.js"></script>
    <script src="introduction/introduction_pages_generation.js"></script>
    <script src="tutorial/tutorial_pages_generation.js"></script>
    <script src="experiment_parameters.js"></script>
    <script src="canvas_drawing.js"></script>
    <!-- Standard scripts -->
    <script src="jspsych/dist/jspsych.js"></script>    
    <script src="jspsych/dist/plugin-instructions.js"></script>
    <script src="jspsych/dist/plugin-image-keyboard-response.js"></script>
    <!-- Plugins (modified) -->
    <script src="jspsych/dist/my-plugin-canvas-keyboard-response.js"></script>
    <!-- <script src="scripts Francesco/my-plugin-instructions.js"></script> -->
    <!-- Styling -->
    <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <script type="module">

        /* initialize jsPsych */
        var jsPsych = initJsPsych({
            on_finish: function() {
            console.log("experiment is over")
            jsPsych.data.displayData();
            }
        });

        /* create timeline */
        var timeline = [];


        /* INTRODUCTIVE PAGES */
        // showing informative pages about the study (informed consent, aim, privacy)
        let introduction = {
        type: jsPsychInstructions,
        pages: generateIntroductionPages(),
        key_forward: "ArrowRight"
        }
        timeline.push(introduction)


        /* INSTRUCTIONS */
        // showing instructions for the study
        let instructions = {
        type: jsPsychInstructions,
        pages: generateInstructionsPages(),
        // show_clickable_nav: true    //subjects will be able to navigate through the pages
        key_forward: "ArrowRight"
        }
        timeline.push(instructions)
        


        /* TASK FAMILIARIZATION */
        /* (KEEP ON FROM HERE, 08/03/2023)
        // creating the trials for the task familiarization
        for (let presentationIndex = 0; presentationIndex < Object.keys(taskFamiliarizationObject).length; presentationIndex++) {
            
            console.log(taskFamiliarizationObject[presentationIndex+1][0] == "visualization trial")

            // creating general currentFamiliarizationTrial object, the other properties will be defined in the ifs:
            let currentFamiliarizationTrial = {
                type: jsPsychImageKeyboardResponse,    
                stimulus_height: 500, 
                response_ends_trial: true,                                            
            }

            if ( taskFamiliarizationObject[presentationIndex+1][0] == "visualization trial" ) {
                // visualization trial (subject goes to next visualization by pressing the spacebar):
                currentFamiliarizationTrial.stimulus = `tutorial/task_familiarization_images/${taskFamiliarizationObject[presentationIndex+1][2]}.PNG`
                currentFamiliarizationTrial.prompt = `<p>${taskFamiliarizationObject[presentationIndex+1][1]}</p>`
                currentFamiliarizationTrial.choices = [' ']

                console.log("visualization trial created")

                } else if (taskFamiliarizationObject[presentationIndex+1][0] == "choice trial") {
                // choice trial:
                currentFamiliarizationTrial.stimulus = `tutorial/task_familiarization_images/${taskFamiliarizationObject[presentationIndex+1][2]}.PNG`
                currentFamiliarizationTrial.prompt = `<p>${taskFamiliarizationObject[presentationIndex+1][1]}</p>`
                currentFamiliarizationTrial.choices = ['ArrowLeft','ArrowRight'],
                
                console.log("choice trial created")
                
                } else if (taskFamiliarizationObject[presentationIndex+1][0] == "feedback trial") {
                // feedback trial:
                currentFamiliarizationTrial.stimulus = `tutorial/task_familiarization_images/${taskFamiliarizationObject[presentationIndex+1][4]}.PNG`,
                currentFamiliarizationTrial.choices = [' ']
                // accessing last response given:
                let currentData = jsPsych.data.get()
                console.log(currentData)
                //let lastResponse = currentData.last(1).values()[0].response
                // checking correctness of last response and changing prompt accordingly:
                if (lastResponse == taskFamiliarizationObject[presentationIndex+1][1]) {
                    // correct response        
                    currentFamiliarizationTrial.prompt = taskFamiliarizationObject[presentationIndex+1][2]
                } else {
                    // wrong response
                    currentFamiliarizationTrial.prompt = taskFamiliarizationObject[presentationIndex+1][3]                
                }
                console.log("feedback trial created")
            }

        timeline.push(currentFamiliarizationTrial)

        }
        */


        /* AGREEMENT TO START EXPERIMENT */
        // informing that the experiment will start and subject agrees
        // POSSIBLE IMPROVEMENT: use external-HTML plugin (with "agreement_page.html"), so that it is possible to use checkbox and check agreement with a function (alert if clicking something else)
        let consent_form = {
            type: jsPsychInstructions,
            pages: [`<p> By clicking the "Space" you are expressing your consent in taking part in the study, and you confirm to: <br>
             - have carefully read the explanations regarding this study and the full experimental procedure;<br>
             - have been informed regarding the scope and aims of the present research;<br>
             - have had the possibility of asking questions regarding any aspect of the experimental procedure and to have obtained satisfying answers;<br>
             - be aware of the possible risks related with the experiment;<br>
             - have received satisfying assurance regarding the confidentiality of the information collected through the testing of your data;<br>
             - be aware that you can withdraw in any phase of the study.<br><br> 
             Press "Space" to start the experiment.
             </p>`],
             key_forward: " "
        };
        timeline.push(consent_form)
        

        /* DRAWING STIMULI: */
            // FUNCTION THAT WILL DRAW THE STIMULI GIVEN THE CHOSEN ORDER OF THE NODES:
            function generateDrawCanvas(presentationIndex) {
                /* INPUT: 
                - presentationIndex (the number that identifies the couple of graphs that is being displayed)

                OUTPUT:
                - display of the stimuli on the screen
                */    

                // function that generates the stimuli:
                function drawCanvas(c) {

                    // addressing canvas
                    let ctx = c.getContext("2d"); 

                    // for each presentation, shuffling the standard order of the nodes (adding "slice()" so that the value of "currentExperiment.standardOrderOfNodes" is not modified):
                    let currentTrialOrder = shuffleNodes(currentExperiment.standardOrderOfNodes.slice())
                    // global variable that temporarily stores the order of the nodes (it keeps changing, and its value is read from plugin to store the order in the corresponding trial)
                    jsPsych.data.presentedOrder = currentTrialOrder
                    // global variable that temporarily stores the current size of the clique (it keeps changing, and its value is read from plugin to store the order in the corresponding trial)
                    jsPsych.data.cliqueSize = currentExperiment.arrayOfCliqueSizes[presentationIndex]

                    // global variable that temporarily stores the correct answer for the current presentation (it keeps changing, and its value is read from plugin to store the order in the corresponding trial)
                    if(currentExperiment.graphsToDisplay[presentationIndex][0][currentExperiment.numberOfNodes] == "clique is absent") 
                        //if first stimulus doesn't have the clique, then the graph with the clique (correct answer) is on the right side
                        jsPsych.data.correctResponse = "arrowright"
                     else
                        jsPsych.data.correctResponse = "arrowleft"

                    // Calling function to draw the two stimuli:
                    drawStimuli(ctx,presentationIndex,currentTrialOrder)
                    
                    // accessing the array of the trials completed up to now:
                    let currentTrialsArray = jsPsych.data.get().trials
                    // Calling function to draw accuracy:
                    drawAccuracy(ctx,presentationIndex,currentTrialsArray)
                    // Calling function to draw number of remaining randomizations for current presentation:
                    drawRemainingRandomizations(ctx,presentationIndex,currentTrialsArray)

                    }
                
                return drawCanvas

            }
            

    /* ACTUAL JSPSYCH SCRIPT: */
    // POSSIBLE IMPROVEMENTS:
    // - entering fullscreen before starting real experiment (https://www.jspsych.org/7.0/plugins/fullscreen/)
    // - resizing screen to control for effective physical size of stimuli (https://www.jspsych.org/7.0/plugins/resize/)

        // creating the trials for the experiment
        for (let presentationIndex = 0; presentationIndex < currentExperiment.numberOfPresentations; presentationIndex++) {
            
            // defining the current trial
            let currentTrial = {
            type: jsPsychCanvasKeyboardResponse, 
            canvas_size: [currentExperiment.canvasDimensions[0], currentExperiment.canvasDimensions[1]], // [height,width]
            // prompt: '<p> Which of the two matrices contains the clique? <br> Press the left arrow to indicate the left one, press the right arrow to indicate the right one. <br> Press Spacebar to reorder the nodes of the two graphs </p>',
            choices: [' ', 'ArrowLeft','ArrowRight'],
            response_ends_trial: true,
            timeline: [],
            data: {
                // other parameters for the exp go here
                presentationNumber: presentationIndex, //NB: one trial is a couple of graphs presented on the screen
                }  
            }
      
            // adding the stimulus to the timeline of the trial
            // NB: shuffling of nodes is done inside draw function
            currentTrial.timeline.push({stimulus: generateDrawCanvas(presentationIndex)})

            // repeating the trial until a final answer (left/right arrow press) is given:
            let loop_node = {
            timeline: [currentTrial],
            loop_function: function(data){
                // accessing the data stored up to now (it will increase progressively):
                let currentData = jsPsych.data.get()

                if (currentData.trials.filter(element => element.presentationNumber == presentationIndex).length == currentExperiment.maximumNumberOfRandomizations) {
                    // if number of repetitions exceeded the limit for the current stimulus, moving to next stimulus:
                    console.log("maximum number of randomizations for this presentation, moving on to the next one")
                    return false
                }  else if(currentData.last(1).values()[0].response == " "){
                    // if last response was a spacebar press, repeat the trial
                    return true 
                } else if(currentData.last(1).values()[0].response == 0 || currentData.last(1).values()[0].response == 1) {
                    // if last response was on left/right arrow, moving to next trial
                    console.log("arrow clicked, moving to next trial")
                    return false 
                }
            }
            } 
            
            // adding the loop node to the timeline
            timeline.push(loop_node)
        
        }

        /* start the experiment */
        jsPsych.run(timeline);

    </script>

</body>
</html>
